name: UE Automation Build
run-name: ${{ gitea.actor }} is building the project
on:
  push:
    branches:
      - main
    tags:
      - 'v*' # å½“æ¨é€ v1.0, v0.0.1 ç­‰æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-linux-job:
    runs-on: ue-runner
    container:
      image: gitea/runner-images:ubuntu-latest
      volumes:
        - /media/blacksnow/devssd/code/UnrealEngine:/opt/UE
        # æŒ‚è½½å®¿ä¸»æœºçš„ LFS ç¼“å­˜ (åªè¯»)ï¼Œé¿å…é‡å¤ä¸‹è½½ 8GB æ•°æ®
        - /home/blacksnow/Documents/Unreal Projects/testLayr/.git/lfs:/mnt/host-lfs:ro
    
    steps:
      - name: Install System Dependencies
        run: |
          apt-get update
          apt-get install -y git git-lfs wget apt-transport-https software-properties-common iputils-ping
          # å®‰è£… UE ç¼–è¯‘ä¾èµ– (æ–°å¢ libnss3 ç­‰è¿è¡Œæ—¶åº“)
          apt-get install -y build-essential clang cmake python3 libicu-dev libssl-dev zlib1g-dev libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2t64
          # å®‰è£… .NET 6.0
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 6.0 --install-dir /usr/share/dotnet
          ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet
          git lfs install

      - name: System Diagnostics (Network & I/O)
        run: |
          echo "ğŸ“Š --- Disk Write Speed (DD) ---"
          # å†™å…¥ 512MB æ•°æ®æµ‹è¯•ç£ç›˜å†™å…¥é€Ÿåº¦ (oflag=direct ç»•è¿‡ç¼“å­˜)
          dd if=/dev/zero of=./speedtest.tmp bs=1M count=512 oflag=direct
          rm ./speedtest.tmp

          echo "ğŸŒ --- Network Check ---"
          # å°è¯•è§£æå¹¶ Ping å†…éƒ¨å®¹å™¨å 'gitea'
          echo "Testing internal DNS 'gitea'..."
          ping -c 2 gitea || echo "âŒ Cannot resolve/ping 'gitea'"
          
          echo "Testing Gateway IP '172.18.0.1'..."
          ping -c 2 172.18.0.1 || echo "âŒ Cannot ping Gateway"
          
          echo "â¬‡ï¸ --- HTTP Connection Speed (Internal) ---"
          # ä¼˜å…ˆå°è¯•ä½¿ç”¨å†…éƒ¨å®¹å™¨å
          if ping -c 1 gitea >/dev/null 2>&1; then
            TEST_HOST="gitea"
          else
            TEST_HOST="172.18.0.1"
          fi
          echo "Testing speed to: $TEST_HOST"
          curl -s -w "Connect: %{time_connect}s\nSpeed: %{speed_download} bps\n" -o /dev/null http://$TEST_HOST:3000/ || echo "Curl failed"

      - name: Manual Checkout Code
        # ä½¿ç”¨ç¯å¢ƒå˜é‡ç›´æ¥æ‹‰å–æœ¬åœ° Gitea çš„ä»£ç ï¼Œä¸èµ° GitHub
        run: |
          # --- å‡†å¤‡å·¥ä½œ ---
          git init
          
          # è‡ªåŠ¨æ£€æµ‹æœ€ä½³è¿æ¥åœ°å€
          if ping -c 1 gitea >/dev/null 2>&1; then
            echo "âœ… Detected internal network, using hostname 'gitea'"
            TARGET_HOST="gitea"
          else
            echo "âš ï¸ Internal network unreachable, falling back to Gateway IP"
            TARGET_HOST="172.18.0.1"
          fi
          
          # æ„é€ å¸¦ Token çš„ URL
          AUTH_URL="http://${{ gitea.actor }}:${{ secrets.GITHUB_TOKEN }}@${TARGET_HOST}:3000/${{ gitea.repository }}.git"

          # --- å…³é”®ä¼˜åŒ– 1: ç¦ç”¨ Checkout æ—¶çš„ LFS è‡ªåŠ¨ä¸‹è½½ ---
          # è¿™è¡Œå‘½ä»¤èƒ½æŠŠ 3 å°æ—¶çš„ç­‰å¾…å˜æˆ 3 ç§’ï¼æˆ‘ä»¬ç¨åæ‰‹åŠ¨æ‹‰å–èµ„æºã€‚
          export GIT_LFS_SKIP_SMUDGE=1

          # --- å…³é”®ä¿®æ­£ 2: æ·»åŠ  origin ---
          # å…ˆæ·»åŠ è¿œç¨‹ä»“åº“ï¼Œè¿™æ · git lfs pull origin å°±ä¸æŠ¥é”™äº†
          git remote add origin "$AUTH_URL"

          # --- æ‹‰å–ä»£ç  ---
          echo "ğŸš€ 1. æé€Ÿæ‹‰å–ä»£ç  (ä¸å«å¤§æ–‡ä»¶)..."
          git fetch --depth 1 origin ${{ gitea.sha }}
          git checkout FETCH_HEAD

          # --- æ‰‹åŠ¨æ‹‰å– LFS ---
          echo "ğŸ”§ 2. é…ç½® LFS åŠ é€Ÿ..."
          git lfs install
          # æ˜¾å¼æŒ‡å®š LFS æ¥å£åœ°å€
          git config lfs.url "$AUTH_URL/info/lfs"
          # ä¼˜åŒ– 1: é™ä½å¹¶å‘ï¼Œé¿å…æœåŠ¡ç«¯è¿‡è½½ (ä» 8 é™ä¸º 4)
          git config lfs.concurrenttransfers 4
          # ä¼˜åŒ– 2: å¢å¤§ HTTP ç¼“å†²åŒºï¼Œå‡å°‘åˆ†åŒ…
          git config http.postBuffer 524288000
          # ä¼˜åŒ– 3: ç¦ç”¨ LFS é”æ ¡éªŒï¼Œå‡å°‘ API è¯·æ±‚
          git config lfs.locksverify false
          # å¢åŠ è¶…æ—¶å®¹å¿
          git config lfs.activitytimeout 120

          # --- ä¼˜åŒ– 0: ä»å®¿ä¸»æœºæ¢å¤ LFS ç¼“å­˜ ---
          if [ -d "/mnt/host-lfs/objects" ]; then
            echo "âš¡ æ£€æµ‹åˆ°æœ¬åœ° LFS ç¼“å­˜ï¼Œæ­£åœ¨å¤åˆ¶..."
            mkdir -p .git/lfs
            # ä½¿ç”¨ cp -n è·³è¿‡å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œ-r é€’å½’
            cp -rn /mnt/host-lfs/objects .git/lfs/
            echo "âœ… LFS ç¼“å­˜æ¢å¤å®Œæˆ"
          fi

          echo "ğŸ“¦ 3. å¼€å§‹é«˜é€Ÿä¸‹è½½ LFS èµ„æº (å¸¦è¿›åº¦æ¡)..."
          # è¿™æ¬¡ä¸‹è½½ä¼šæœ‰è¯¦ç»†çš„è¿›åº¦æ˜¾ç¤º
          git lfs pull origin
      - name: Verify LFS Assets
        run: |
          echo "æ£€æŸ¥æ ¸å¿ƒèµ„äº§å¤§å°..."
          # æ‰¾ä¸€ä¸ªé¡¹ç›®é‡Œå·²çŸ¥çš„å¤§èµ„äº§æ–‡ä»¶ï¼ˆæ¯”å¦‚æŸå¼ è´´å›¾æˆ–æ¨¡å‹ï¼‰
          # å¦‚æœåªæœ‰å‡ ç™¾å­—èŠ‚ï¼Œè¯´æ˜ LFS è¿˜æ˜¯æ²¡æ‹‰ä¸‹æ¥
          find . -name "*.uasset" | head -n 20 | xargs ls -lh
      - name: Check Files
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•å†…å®¹ï¼š"
          ls -R | head -n 20 || true
          find . -name "*.uproject"
          
      - name: Fix Engine Permissions
        run: |
          chmod +x /opt/UE/Engine/Build/BatchFiles/RunUAT.sh
          chmod +x /opt/UE/Engine/Binaries/DotNET/UnrealBuildTool/UnrealBuildTool
          chmod -R +x /opt/UE/Engine/Binaries/Linux/

      - name: Compile Project Editor (Skip Engine)
        run: |
          # ç¡®ä¿ UID 1000 ç”¨æˆ·å­˜åœ¨
          TARGET_USER=$(getent passwd "1000" | cut -d: -f1)
          if [ -z "$TARGET_USER" ]; then
            useradd -m -u 1000 ueuser
            TARGET_USER="ueuser"
          fi
          echo "Running as user: $TARGET_USER"

          # åˆ‡æ¢åˆ°è¯¥ç”¨æˆ·è¿è¡Œï¼Œé¿å… root æƒé™é—®é¢˜
          chown -R 1000:1000 . || true
          su $TARGET_USER << EOF
          export PATH=$PATH:/usr/bin/dotnet
          PROJECT_PATH=\$(find ${{ github.workspace }} -name "*.uproject" -print -quit)
          # æ˜¾å¼ç¼–è¯‘é¡¹ç›®çš„ Editor Targetï¼Œä½†ä¸ç¼–è¯‘å¼•æ“
          /opt/UE/Engine/Build/BatchFiles/Linux/Build.sh LyraEditor Linux Development -Project="\$PROJECT_PATH" -WaitMutex -FromMsBuild
          EOF

      - name: Compile and Build
        run: |
          # ç¡®ä¿ UID 1000 ç”¨æˆ·å­˜åœ¨
          TARGET_USER=$(getent passwd "1000" | cut -d: -f1)
          if [ -z "$TARGET_USER" ]; then
            useradd -m -u 1000 ueuser
            TARGET_USER="ueuser"
          fi
          echo "Running as user: $TARGET_USER"

          # åˆ‡æ¢åˆ°è¯¥ç”¨æˆ·è¿è¡Œ
          su $TARGET_USER << EOF
          export PATH=$PATH:/usr/bin/dotnet
          PROJECT_PATH=\$(find ${{ github.workspace }} -name "*.uproject" -print -quit)
          
          /opt/UE/Engine/Build/BatchFiles/RunUAT.sh \
          BuildCookRun \
          -project="\$PROJECT_PATH" \
          -targetplatform=Linux \
          -clientconfig=Development \
          -build -cook -stage -archive \
          -archivedirectory="${{ github.workspace }}/Saved/Builds" \
          -noP4 -utf8output -nocompileeditor \
          -unattended -stdlog
          EOF

      - name: Compress Build Artifacts
        run: |
          echo "ğŸ“¦ Compressing build artifacts..."
          cd ${{ github.workspace }}/Saved/Builds
          # å‹ç¼© Linux ç›®å½•ä¸º tar.gz
          tar -czvf LyraGame-Linux.tar.gz Linux/

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: LyraGame-Linux-Build
          path: ${{ github.workspace }}/Saved/Builds/LyraGame-Linux.tar.gz
          if-no-files-found: error

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ github.workspace }}/Saved/Builds/LyraGame-Linux.tar.gz
          draft: false
          prerelease: false