name: UE Automation Build
run-name: ${{ gitea.actor }} is building the project
on: [push]

jobs:
  build-linux-job:
    runs-on: ue-runner
    container:
      image: gitea/runner-images:ubuntu-latest
      # 将宿主机的引擎目录挂载到容器内部
      volumes:
        - /home/blacksnow/UnrealEngine:/opt/UE
    
    steps:
      - name: Install System Dependencies
        # 补全基础工具和 UE 编译必需的 .NET 运行环境
        run: |
          apt-get update
          apt-get install -y git git-lfs wget apt-transport-https software-properties-common
          # 下载并安装官方 .NET 脚本（针对 UE5 编译）
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 6.0 --install-dir /usr/share/dotnet
          ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet
          git lfs install

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true # 必须拉取 LFS 文件，否则 uproject 会因为找不到插件或资源而报错

      - name: Fix Engine Permissions
        # 核心：确保挂载进来的 RunUAT.sh 和相关二进制文件有执行权限
        run: |
          chmod +x /opt/UE/Engine/Build/BatchFiles/RunUAT.sh
          chmod +x /opt/UE/Engine/Binaries/DotNET/UnrealBuildTool/UnrealBuildTool
          chmod -R +x /opt/UE/Engine/Binaries/Linux/

      - name: Compile and Build
        run: |
          # 检查项目名：请确保文件夹里那个 .uproject 文件的确叫 testLayr.uproject
          /opt/UE/Engine/Build/BatchFiles/RunUAT.sh \
          BuildCookRun \
          -project="${{ github.workspace }}/testLayr.uproject" \
          -targetplatform=Linux \
          -clientconfig=Development \
          -build -cook -stage -archive \
          -archivedirectory="${{ github.workspace }}/Saved/Builds" \
          -noP4 -utf8output -nocompileeditor

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success() # 只有构建成功才会上传
        with:
          name: Game-Build-Linux
          path: Saved/Builds/